{"componentChunkName":"component---src-templates-blog-post-js","path":"/AzureVnet-as-markdown/","result":{"data":{"site":{"siteMetadata":{"title":"Koushik's scribble"}},"markdownRemark":{"id":"9009a1b9-4179-5164-8807-5a2f4391a095","excerpt":"While managing large-scale implementations on cloud platforms, Network Solutions deployments are managed by the application teams themselves or a central teamâ€¦","html":"<!-- Post Content -->\n<p>While managing large-scale implementations on cloud platforms, Network Solutions deployments are managed by the application teams themselves or a central team. Either way, core resources within a Network solution are Virtual Network with Subnets, Network Security Groups, Route Tables and VirtualNetwork Hubs. To have an overview of the deployed Network Solutions, user interface or control plane (API) provided by the service provider can help us out. <strong>Now how about documenting the Network solution?</strong> This post describes how to generate documentation of a Network Solution. </p>\n<p><strong><em><a href=\"http://armviz.io/designer\">ARMVIZ</a></em></strong> is an awesome tool to have a graphical view generated based on the exported arm template. To generate details on top of the visualization, what if there is a <code class=\"language-text\">markdown</code> file generated that is attached to the documentation. <strong><em><a href=\"https://nugetmusthaves.com/Tag/markdown\">Here</a></em></strong> we can find top NuGet packages to embed within code to generate one. Now, since I am using C# and PowerShell to work with Azure Infrastructure provisioning, in this post I will go through how using <strong><em><a href=\"https://github.com/BernieWhite/PSDocs\">PSDOCS</a></em></strong> and how I achieved it. </p>\n<h3>Where to start</h3>\n<p>In Azure Networking Architecture, <strong><em><a href=\"https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/hub-spoke?tabs=cli\">Hub-Spoke</a></em></strong> is vastly adopted. Follow <strong><em><a href=\"https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/hub-spoke?tabs=cli\">basic deployment instructions</a></em></strong> of the architecture. </p>\n<p><img src=\"../../assets2021-02-17-Azure-Hub-Spoke-Network-Solution.jpg\"></p>\n<h3>What data is required</h3>\n<p>All the data required to fill in the markdown needs to be populated in a hash table. Below are the details for a VirtualNetwork in general, it could be a Hub or Spoke.</p>\n<ol>\n<li>\n<p>Install PSDOCs PowerShell module</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$null = Install-PackageProvider -Name NuGet -Force -Scope CurrentUser\nInstall-Module -Name PSDocs -RequiredVersion 0.6.3 -Scope CurrentUser -Force\nImport-Module PSDocs</code></pre></div>\n</li>\n<li>\n<p>Get VirtualNetwork Information</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$VirtualNetwork = Get-AzVirtualNetwork -Name $VirtualNetworkName\n$subscription = Get-AzSubscription -SubscriptionId $VirtualNetwork.Id.Split('/')[2]</code></pre></div>\n</li>\n<li>\n<p>Derive Subnets Information from the VirtualNetwork</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[PSCustomObject]@{\n    subnetName    = $subnet.name\n    addressSpace  = $subnet.AddressPrefix\n    LoadBalancer  = $false\n    DisableJITPIM = $false\n}</code></pre></div>\n</li>\n<li>\n<p>Get NSG Information linked to each Subnet and save all security rules into an ArrayList</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$nsg = Get-AzNetworkSecurityGroup -Name ($subnet.NetworksecurityGroup.Id.Split('/')[-1])\n\nForeach ($securityRule in $nsg.SecurityRules) {\n    $nsgRule = [PSCustomObject]@{\n        Name           = $securityRule.Name\n        Direction      = $securityRule.Direction\n        Priority       = $securityRule.Priority\n        Access         = $securityRule.Access\n        'From address' = $securityRule.SourceAddressPrefix\n        'To address'   = $securityRule.DestinationAddressPrefix\n        'From port'    = $securityRule.SourcePortRange\n        'To port'      = $securityRule.DestinationPortRange\n    }\n    $subnetObj.Nsg.SecurityRules.Add($nsgRule) | out-null\n}</code></pre></div>\n</li>\n<li>\n<p>If there are custom DNS Settings also gather that information. Also list all Private DNS Zones linked with the Virtual Network.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$dns = @{\n    \"Name\" = $dnsOption\n}</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$privateDns = Get-AzPrivateDnsZone\n$vnetLinkedPrivateDns = [System.Collections.ArrayList]@()\nforeach ($pdns in $privateDns) {\n    $dnsVnetlink = Get-AzPrivateDnsVirtualNetworkLink -ResourceGroupName $pdns.ResourceGroupName -ZoneName $pdns.Name\n    If($dnsVnetlink.VirtualNetworkId -eq $VirtualNetwork.Id){\n        $vnetLinkedPrivateDns.Add($pdns.ResourceId)\n    }\n}</code></pre></div>\n</li>\n</ol>\n<h3>How to populate</h3>\n<p>PSDocs works by translating <code class=\"language-text\">*.doc.ps1</code> files into a markdown file. To generate a Markdown run the command</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Invoke-PSDocument -Path &lt;location of *.doc.ps1 file> -InputObject &lt;data as Key-value pair or customObject> -OutputPath &lt;location to save the generated markdown file> -Option &lt;if needed additonal settings to support generation of markdown>;</code></pre></div>\n<p>For the above context of Hub-Spoke, a <code class=\"language-text\">BaseTemplate.doc.ps1</code> is created with sections <em>General information</em> and <em>Virtual Network</em>. </p>\n<p><img src=\"../../assets2021-02-17-BaseTemplate.jpg\"></p>\n<p><em>General information</em> contains Subscription, ResourceGroup and other information to identify ownership of the VirtualNetwork.</p>\n<p><em>VirtualNetwork</em> contains multiple sections e.g., <code class=\"language-text\">AddressSpace</code>, <code class=\"language-text\">DNS</code>, <code class=\"language-text\">Subnets</code>, <code class=\"language-text\">RouteTable</code>, <code class=\"language-text\">NSGs</code>, <code class=\"language-text\">Peering</code>. Either all data can be added in the same file or each section can be divided in a separate template. </p>\n<p><img src=\"../../assets2021-02-17-BaseTemplate-VNET.jpg\"></p>\n<p>Upon generation of each subsection, all are merged in the BaseTemplate generated markdown. </p>\n<p>For example, using RouteTable data markdown is generated. The content of the markdown is copied back to the input object that will be used to generate VirtualNetwork section.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$READMERouteTableTemplateName = 'RouteTable.doc.ps1'\nInvoke-PSDocument -Path ('{0}\\SubTemplates\\{1}' -f $TemplatePath, $READMERouteTableTemplateName) -InputObject $readmeObject -OutputPath $OutputPath -Option $options;\n\n# Add content of the generated file as string. \n$readmeObject.RouteTableSection = (Get-Content -Path \"$OutputPath/README.md\" -Encoding UTF8 -Raw).Replace('# ', '## ')</code></pre></div>\n<h2>Sample files</h2>\n<p>That is it, now combining all the steps a Network Solution for a HUB or a SPOKE virtual network can be generated describing every detail in a single page.</p>\n<p>Here is a sample for the </p>\n<ul>\n<li><strong><em><a href=\"https://github.com/koushik-aravalli/development/blob/master/LetsTryDocumenting/Hub/README.md\">HUB VNET</a></em></strong></li>\n<li><strong><em><a href=\"https://github.com/koushik-aravalli/development/blob/master/LetsTryDocumenting/SpokeOne/README.md\">SPOKE VNET</a></em></strong></li>\n</ul>\n<h2>Where to download source code</h2>\n<p>All scripts can be found <strong><em><a href=\"https://github.com/koushik-aravalli/development/tree/master/LetsTryDocumenting\">here</a></em></strong></p>","frontmatter":{"title":"Azure Network Solution as a Markdown","date":"February 17, 2021","description":"","tags":["azure","network","documentation"]}}},"pageContext":{"slug":"/AzureVnet-as-markdown/","previous":{"fields":{"slug":"/Git-helper/"},"frontmatter":{"title":"git commands helper"}},"next":{"fields":{"slug":"/AzureDevOps-Agent-OAuth-CreateBranch/"},"frontmatter":{"title":"Using AzureDevOps Agent's OAuth to create branch"}}}},"staticQueryHashes":["2841359383"]}